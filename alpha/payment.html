<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Payment</title>

  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="css/payment.css" />
</head>

<body class="payment">

  <main class="payment-page">

    <!-- back -->
    <header class="payment-topbar">
      <a class="icon-btn" href="phone.html" aria-label="Back">‹</a>
    </header>

    <!-- title -->
    <h1 class="payment-title">Select Payment Method</h1>

    <!-- payment methods -->
    <section class="payment-methods">

      <div class="payment-option">
        <img class="payment-icon" src="../assets/images/icons/debit.png" alt="Card" />
        <span class="payment-text">Debit/Credit Card</span>
      </div>

      <div class="payment-option">
        <img class="payment-icon" src="../assets/images/icons/applepay.png" alt="Apple Pay" />
        <span class="payment-text">Apple Pay</span>
      </div>

      <div class="payment-option">
        <img class="payment-icon" src="../assets/images/icons/paypal.png" alt="Paypal" />
        <span class="payment-text">Paypal</span>
      </div>

      <div class="payment-option">
        <img class="payment-icon" src="../assets/images/icons/venmo.png" alt="Venmo" />
        <span class="payment-text">Venmo</span>
      </div>

    </section>

    <!-- olive divider -->
    <div class="divider-olive" aria-hidden="true"></div>

    <!-- tip section -->
    <section class="tip-section">
      <h2 class="tip-title">Add Tip?</h2>

      <div class="tip-row">
        <div class="tip-box">
          <p class="tip-percent">10%</p>
          <p class="tip-amount">$0.70</p>
        </div>

        <div class="tip-box">
          <p class="tip-percent">15%</p>
          <p class="tip-amount">$1.05</p>
        </div>

        <div class="tip-box">
          <p class="tip-percent">20%</p>
          <p class="tip-amount">$1.40</p>
        </div>

        <div class="tip-box">
          <p class="tip-percent">Custom</p>
        </div>
      </div>
    </section>

    <!-- dashed pink divider -->
    <div class="divider-pink" aria-hidden="true"></div>

    <!-- summary (static display is fine for now) -->
    <section class="summary">

      <div class="summary-row">
        <div class="summary-left">
          <p class="summary-bold">1x Egg &amp; Cheese</p>
          <p class="summary-bold">+Bacon</p>
        </div>
        <div class="summary-right">
          <p class="summary-bold">$6.00</p>
          <p class="summary-bold">$1.00</p>
        </div>
      </div>

      <div class="summary-row">
        <p class="summary-regular">Tip (0%)</p>
        <p class="summary-regular">$0.00</p>
      </div>

      <div class="summary-row">
        <p class="summary-regular">Tax</p>
        <p class="summary-regular">$1.34</p>
      </div>

      <div class="summary-row total-row">
        <p class="total-label">Total</p>
        <p class="total-amount">$8.34</p>
      </div>

    </section>

    <!-- button -->
    <section class="payment-footer">
      <button class="primary-btn" id="placeOrderBtn">Place Order</button>
    </section>

  </main>

  <!-- Apple Pay Overlay -->
  <div class="applepay-overlay" id="applePayOverlay" aria-hidden="true">
    <div class="applepay-sheet" role="dialog" aria-modal="true" aria-label="Apple Pay">

      <div class="applepay-header">
        <div class="applepay-logo">Pay</div>

        <button class="applepay-close" id="applePayCloseBtn" type="button" aria-label="Close Apple Pay">
          ×
        </button>
      </div>

      <div class="applepay-card">
        <div class="applepay-card-left">
          <div class="applepay-card-icon"></div>
          <div class="applepay-card-text">
            <div class="applepay-card-title">Revolut Visa</div>
          </div>
        </div>
        <div class="applepay-card-right">
          <span class="applepay-dots">•••• 1234</span>
          <span class="applepay-chevron">›</span>
        </div>
      </div>

      <div class="applepay-card">
        <div class="applepay-card-left">
          <div class="applepay-card-title">Change Payment Method</div>
        </div>
        <div class="applepay-card-right">
          <span class="applepay-chevron">›</span>
        </div>
      </div>

      <div class="applepay-meta">
        <div class="applepay-company">Company Name</div>
        <div class="applepay-amount">$8.34</div>
        <div class="applepay-info">i</div>
      </div>

      <div class="applepay-faceid">
        <div class="faceid-icon" aria-hidden="true">
          <div class="faceid-box"></div>
          <div class="faceid-smile"></div>
        </div>
        <div class="faceid-text">Pay with Face ID</div>
      </div>

    </div>
  </div>

  <!-- ✅ MAIN LOGIC (save last order + clear cart + redirect) -->
  <script type="module">
    import { getCart, saveLastOrder, clearCart } from "/alpha/js/app.js";

    const placeOrderBtn = document.getElementById("placeOrderBtn");
    const applePayOverlay = document.getElementById("applePayOverlay");
    const applePayCloseBtn = document.getElementById("applePayCloseBtn");

    placeOrderBtn.addEventListener("click", () => {
      applePayOverlay.classList.add("active");

      // ✅ snapshot the order so confirmation + banner can show it later
      const cart = getCart();
      const total = cart.reduce(
        (sum, item) => sum + (Number(item.price || 0) * (item.qty || 1)),
        0
      );

      saveLastOrder({
        orderNumber: 32,      // keep your static number
        readyBy: "11:00am",
        items: cart,
        total: total
      });

      // ✅ show confirmation banner later on homepage
      localStorage.setItem("hasRecentOrder", "true");

      // ✅ clear the cart AFTER order is placed
      clearCart();

      // go to confirmation after Apple Pay sheet appears
      setTimeout(() => {
        window.location.href = "confirmation.html";
      }, 2000);
    });

    applePayCloseBtn.addEventListener("click", () => {
      applePayOverlay.classList.remove("active");
    });

    applePayOverlay.addEventListener("click", (e) => {
      if (e.target === applePayOverlay) {
        applePayOverlay.classList.remove("active");
      }
    });
  </script>

  <!-- ✅ Active states (payment + tips) -->
  <script>
    // Payment selection
    const paymentOptions = document.querySelectorAll(".payment-option");
    paymentOptions.forEach(option => {
      option.addEventListener("click", () => {
        paymentOptions.forEach(o => o.classList.remove("is-selected"));
        option.classList.add("is-selected");
      });
    });

    // Tip selection
    const tipBoxes = document.querySelectorAll(".tip-box");
    tipBoxes.forEach(box => {
      box.addEventListener("click", () => {
        tipBoxes.forEach(b => b.classList.remove("is-selected"));
        box.classList.add("is-selected");
      });
    });
  </script>

</body>
</html>